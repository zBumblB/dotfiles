#!/bin/sh

while getopts "p" arg; do
	case ${arg} in
		p) perm=1 ;;
		*) exit 1
	esac
done

shift $((OPTIND - 1))

newbg="$HOME/Pictures/wallpapers/used"
[ -e "$1" ] && newbg="$1" 

newbg=$(find -L "$newbg" -iregex '.*.\(jpg\|jpeg\|png\|gif\)' -type f | shuf -n 1)

[ -n "$perm" ] && [ -f "$newbg" ] && (
	rm "$WALLPAPER"
	ln -s "$newbg" "$WALLPAPER"
)

[[ $(file --mime-type -bL "$newbg") =~ image/* ]] && (
	notify-send "Changing wallpaper..." "$newbg"
	swaymsg output '*' bg "$newbg" fill > /dev/null 2>&1
	xwallpaper --zoom "$newbg"
	echo "$newbg"
) || notify-send "Error" "Failed to set wallpaper"
